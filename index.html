<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard MartÃ­n v13.1</title>
    <style>
        :root { --p: #1a2a3a; --a: #3498db; --s: #27ae60; --d: #e74c3c; --bg: #f0f2f5; --m: #e67e22; --j: #95a5a6; --cp: 20px; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
        .container { max-width: 1300px; margin: auto; padding-bottom: 50px; }
        .header { background: var(--p); color: white; padding: 30px 15px; border-radius: 15px; text-align: center; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        #total-general { font-size: 2.5rem; margin: 10px 0; font-weight: bold; }
        .card { background: white; padding: var(--cp) 0 0 0; border-radius: 12px; margin-bottom: 25px; border-top: 5px solid transparent; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h2 { padding: 0 var(--cp) 12px var(--cp); margin-top: 0; color: #2c3e50; font-size: 1.1rem; border-bottom: 1px solid #f0f0f0; }
        .table-wrap { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #fdfdfd; color: #8898aa; font-size: 10px; padding: 12px 15px; text-transform: uppercase; text-align: left; }
        td { padding: 14px 15px; border-bottom: 1px solid #f9f9f9; font-size: 13px; white-space: nowrap; }
        .pos { color: var(--s); font-weight: bold; }
        .neg { color: var(--d); font-weight: bold; }
        .section-total { text-align: right; font-weight: bold; padding: 18px var(--cp); background: #fff; border-top: 1px solid #eee; color: var(--p); }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <small>PATRIMONIO CONSOLIDADO</small>
        <h1 id="total-general">$ 0,00</h1>
        <div id="sync-info" style="font-size: 11px; opacity: 0.6;">Sincronizado âœ…</div>
    </div>
    <div id="cards-container"></div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz2_lXqHUObQPxtt9nMccpxd56Bw-62OQxX8Cf1DHmWOgE0NbMraSTGoYkw0v_k1syJXA/exec";
    const margin = -269051; // Tu margen de deuda fijo
    const fmt = (v) => (v || 0).toLocaleString('es-AR', {minimumFractionDigits:2, maximumFractionDigits:2});

    const categories = {
        "STOCKS": { label: "ðŸ“ˆ Acciones", color: "var(--a)" },
        "FCI": { label: "ðŸ‡¦ðŸ‡· Fondos Argentina", color: "var(--s)" },
        "MARTIN": { label: "ðŸ¦ Mutual Funds - MartÃ­n", color: "var(--m)" },
        "JORGE": { label: "ðŸ¦ Mutual Funds - Jorge", color: "var(--j)" }
    };

    async function fetchData() {
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            render(data);
            document.getElementById('sync-info').innerText = "Sincronizado âœ…";
        } catch (e) { document.getElementById('sync-info').innerText = "Sync Error âŒ"; }
    }

    function render(data) {
        let globalTotal = 0;
        let catsData = { STOCKS: {html:"", sub:0, dc:0}, FCI: {html:"", sub:0, dc:0}, MARTIN: {html:"", sub:0, dc:0}, JORGE: {html:"", sub:0, dc:0} };

        data.forEach(r => {
            const cat = (r[6] || "").toUpperCase().trim(); // Columna G
            if (!catsData[cat]) return;

            const name = r[0]; // Ticker
            const q = parseFloat(r[1]) || 0; // Cantidad
            const p = parseFloat(r[2]) || 0; // Precio
            const dc_val = parseFloat(r[5]) || 0; // Cambio Dia $ x Q (Col F)
            const dc_pct = parseFloat(r[4]) || 0; // Cambio Dia % (Col E)
            const sub = p * q;

            catsData[cat].sub += sub;
            catsData[cat].dc += dc_val;

            // Ajuste visual para NAV de FCI (divisiÃ³n por 1000)
            const pDisp = cat === "FCI" ? (p/1000).toFixed(6) : p.toFixed(2);
            const dcDisp = cat === "FCI" ? dc_val/1000 : dc_val;
            
            // Fix para porcentajes si vienen como decimal (0.0119 -> 1.19%)
            const pctDisp = (Math.abs(dc_pct) < 1.0) ? (dc_pct * 100) : dc_pct;

            catsData[cat].html += `<tr>
                <td><b>${name}</b></td>
                <td>${q.toLocaleString()}</td>
                <td>$ ${pDisp}</td>
                <td class="${dcDisp>=0?'pos':'neg'}">$ ${fmt(dcDisp)}</td>
                <td class="${pctDisp>=0?'pos':'neg'}">${pctDisp.toFixed(2)}%</td>
                <td style="text-align:right; font-weight:bold;">$ ${fmt(sub)}</td>
            </tr>`;
        });

        let containerHtml = "";
        for (const [key, config] of Object.entries(categories)) {
            const d = catsData[key];
            if (d.html === "") continue;

            const netSub = key === "STOCKS" ? (d.sub + margin) : d.sub;
            const netAyer = netSub - d.dc;
            const netPct = netAyer !== 0 ? (d.dc / netAyer) * 100 : 0;
            globalTotal += netSub;

            containerHtml += `
                <div class="card" style="border-top-color: ${config.color}">
                    <h2>${config.label}</h2>
                    <div class="table-wrap">
                        <table>
                            <thead><tr><th>Activo</th><th>Cant.</th><th>Precio</th><th>DÃ­a $</th><th>DÃ­a %</th><th style="text-align: right;">Total</th></tr></thead>
                            <tbody>${d.html}</tbody>
                        </table>
                    </div>
                    <div class="section-total">
                        ${key === "STOCKS" ? 'Net Acciones (inc. Margen): ' : 'Subtotal: '} 
                        $ ${fmt(netSub)} | Var. DÃ­a: <span class="${d.dc>=0?'pos':'neg'}">${netPct.toFixed(2)}%</span>
                    </div>
                </div>`;
        }

        document.getElementById('cards-container').innerHTML = containerHtml;
        document.getElementById('total-general').innerText = `$ ${fmt(globalTotal)}`;
    }

    fetchData();
    setInterval(fetchData, 60000);
</script>
</body>
</html>
